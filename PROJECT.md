# Project Brief: Bitcoin Minute Prediction Game

## Overview

This project is a simple **web app** where users make short-term predictions (bets) on whether the **BTC/USD price** goes **up or down** after one minute. The game provides real-time market visualization, user score tracking, and persistent bet data storage.

The app consists of three main components:
- **Frontend (FE)** â€” A React + TypeScript single-page interface
- **Backend (BE)** â€” A Node.js + TypeScript REST API
- **Database (DB)** â€” A simple SQL database (MariaDB initially, compatible with PostgreSQL)

---

## Core Concept

The app lets users:
1. Automatically **create a session** on first use
2. View the **current BTC/USD market price** (from Binance API)
3. Place a **Long Bet (Up)** or **Short Bet (Down)** predicting if the price will rise or fall in one minute
4. View **their current score**
5. Resume their session using a **cookie-based player ID**

---

### Authentication Flow

JWT tokens are used for authorization to prevent user impersonation

- On first use, the frontend requests a `token` from the backend
- The frontend includes the `token` in all subsequent requests
- The backend ensures that the `token` is valid and uses it to identify the user

## Functional Requirements

### Gameplay Rules

- Each player starts with a **score of 0**
- The player can only have **one active bet** at a time
- Bets **resolve after one minute**, rounded up to `:00` seconds
- Once complete, the system compares:
  - **Creation Price** (when bet is placed)
  - **Resolution Price** (after one minute)
- If the prediction is correct:
  - Score += 1
- If incorrect:
  - Score âˆ’= 1

---

## Architecture

### Frontend

- **Stack:** React + TypeScript + Vite
- **UI Components:**
  - **Left Panel:**
    - Top: Userâ€™s **Name** (editable; nice to have) and **Score**
    - Bottom Left: **Leaderboard** with users' names and scores (nice to have)
  - **Main Section:** Two buttons:
    - Right: **Ticker name** BTCUSDT (ticker selection is a nice to have) and **Current price**
    - Left: **Place a bet** or **Current bet price**
      - ðŸŸ© Long Bet (Up)
      - ðŸŸ¥ Short Bet (Down)
  - **Bottom Section:**
     - **Candlestick chart** with 1s granularity (nice to have)

- **Current Price** and **Chart** are updated every second with polling (Websocket is a nice to have)
- **Leaderboard** is updated every minute or when the user name is changed
- **Chart** uses OHLC data fetched from the BE
- **Authorization** JWT token is stored as an HTTP cookie

---

### API

- **Endpoints:**

  | Method | Endpoint | Description |
  |--------|----------|-------------|
  | `POST` | `/auth` | Creates a new user/session |
  | `GET` | `/score` | Returns the user's score |
  | `GET` | `/scores` | Returns a list of users and their scores (nice to have) |
  | `POST` | `/name` | Sets the user name (nice to have) |
  | `GET` | `/tickers` | Returns the list of supported tickers |
  | `POST` | `/bet/{ticker}/{short\|long}` | Creates a new bet |
  | `GET` | `/price/{ticker}/current` | Returns current price |
  | `GET` | `/price/{ticker}/history` | Returns OHLC price data for the last 120 seconds (nice to have) |

---

### Backend

- **Stack:** Node.js + TypeScript

- **Authentication Logic**
  - The `POST /auth` endpoint creates a user and returns their `token`
  - `token` is in JWT format, signed with a backend secret and contains `user_id` in the payload
  - `user_id` is generated by the DB on insert to the `users` table
  - `token` is required to be present in the `Authorization` HTTP header for all other endpoints
  - `token` signature is validated by the backend using the secret; an error is returned if the signature is invalid
  - The user is identified based on the `user_id` in the token

- **Market Data Service:**
  - Fetches 1s granularity market data using **Binance API**
  - Caches data for the last 120 seconds
  - Returns current or historical data
  - Uses the **Candlestick REST API** for historical price requests
  - Uses the **Candlestick Stream Websocket API** for current price requests
  - The websocket session is closed if no current price request arrives in the last 5 minutes

- **Business Logic:**
  - Bets are stored in the `bets` table
  - `POST /bet` performs an insertion
  - Resolution time is calculated by adding one minute to the current time, then rounding up to `:00` seconds
  - A unique open bet constraint is enforced via the DB
 
- **Bet Resolution Service**
  - A worker task runs in the background
  - Wakes up every minute at the :00 second mark
  - Reads open bets from the `bets` table
  - Calls the market data service to get the price at resolution
  - Updates the score in the `users` table
  - Updates the status and resolution time in the `bets` table
  - Sleeps until the beginning of the next minute after wakeup

---

### Database Schema

**Table: `bets`**

| Column | Type | Description |
|--------|------|-------------|
| `bet_id` | INT (PRIMARY KEY AUTO INCREMENT) | Unique bet identifier |
| `user_id` | INT | User identifier |
| `ticker` | VARCHAR | Ticker symbol (e.g., BTCUSDT) |
| `opened_at` | DATETIME | Time when bet was opened |
| `resolve_at` | DATETIME | Bet resolution time |
| `direction` | ENUM('LONG','SHORT') | Bet type |
| `open_price` | DECIMAL(10,4) | Price when bet was opened |
| `resolution_price` | DECIMAL(10,4) (nullable) | Price at resolution |
| `status` | ENUM('OPEN','WON','LOST') | Bet status |
| **Indexes** | (`user_id`, `resolve_at` DESC) | For listing bets per user |
| **Constraint** | UNIQUE INDEX (`user_id`, `ticker`) WHERE `status` = 'OPEN' | Ensures one active bet per ticker per user |

**Table: `users`**

| Column | Type | Description |
|--------|------|-------------|
| `user_id` | INT (PRIMARY KEY AUTO INCREMENT) | Unique user identifier |
| `created_at` | DATETIME | Time when the user account was created |
| `last_bet_placed_at` | DATETIME | Last time when the user placed a bet |
| `score` | INT | Current score |

**Table: `schema_history`**

| Column | Type | Description |
|--------|------|-------------|
| `migration_id` | INT (PRIMARY KEY AUTO INCREMENT) | Unique migration identifier |
| `applied_at` | DATETIME | Timestamp when the migration was applied |

---

### Database Migrations

- A very simple custom migration approach is used
- A **Migration Service** runs on each startup of the backend
  - It queries the latest applied migration from the `schema_history` table
  - It applies missing migrations one by one
- Migration scripts are stored inline as multi-line string constants

---

## Deployment

The application runs as **three Docker containers**, all based on **Alpine images**:

1. **Frontend Container**
   - static React build served by **nginx**
   - Also acts as a **reverse proxy** to the backend API

2. **Backend Container**
   - Node.js server (REST API)
   - Connects to the DB and Binance API

3. **Database Container**
   - MariaDB instance
   - Stores all bets

**Container Registry:** GitHub Container Registry (GHCR)

---

## Enhancements

- Chart
- Leaderboard
- Multiple ticker support (ETHUSD, SOLUSD, etc)
- Password and Google authentication
- Move DB to managed cloud service (AWS RDS)

---

## Suggested Milestones

### **Milestone 1: Setup & Scaffolding**
- [ ] **Repository:** Initialize monorepo and Git workflow
- [ ] **Scaffolding:** Create FE (Vite/React) and BE (Node/Express) projects
- [ ] **Containerization:** Define `Dockerfiles` and `docker-compose.yml`
- [ ] **CI/CD:** Set up a basic CI/CD pipeline for automated builds

### **Milestone 2: Frontend layout, display current price**
- [ ] **UI Shell:** Implement the static frontend layout and component structure
- [ ] **BE Endpoint:** Create the `GET /price/current` endpoint
- [ ] **BE Service:** Implement `MarketDataService` for current price
- [ ] **FE Integration:** Fetch and display the live price on the frontend

### **Milestone 3: Authentication, display user score**
- [ ] **BE Endpoints:** Create `POST /auth` and `GET /score` endpoints
- [ ] **DB Schema:** Build the initial database schema and `MigrationService`
- [ ] **FE Auth:** Implement the JWT request and storage flow
- [ ] **FE Integration:** Display the user's score

### **Milestone 4: Place and resolve bets**
- [ ] **BE Endpoint:** Create the `POST /bet` endpoint
- [ ] **BE Service:** Implement the `BetResolutionService`
- [ ] **FE UI:** Build the UI for placing bets
- [ ] **FE Integration:** Display the user's active and past bets

---

## Deliverables

- Working **deployed web app** (accessible link)
- GitHub repository containing:
  - Frontend & backend code
  - Dockerfiles & compose config
  - `PROJECT.md` (this document)

---
