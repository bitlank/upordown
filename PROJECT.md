
# Project Brief: Bitcoin Minute Prediction Game

## Overview

This project is a simple **web app** where users can make short-term predictions (bets) on whether the **BTC/USD price** will go **up or down** after one minute. The game provides real-time market visualization, user score tracking, and persistent bet data storage.

The app will consist of three main components:
- **Frontend (FE)** â€” A React + TypeScript single-page interface.
- **Backend (BE)** â€” A Node.js + TypeScript REST API.
- **Database (DB)** â€” A simple SQL database (MariaDB initially, compatible with PostgreSQL).

---

## Core Concept

The app lets users:
1. Automatically **create a session** on first use (authentication to be added later)
2. View the **current BTC/USD market price** (from Binance API).
3. Place a **Long Bet (Up)** or **Short Bet (Down)** predicting if the price will rise or fall in one minute.
4. View **past bets** and **their current score**.
5. Resume their session using a **cookie-based player ID**

---

### Authentication Flow

JWT tokens are used for authorization to prevent user impersonation

- On first use a `token` is returned from the backend
- All subsequent requests must include the token
- The backend returns an error if the token is invalid or belongs to a different user

## Functional Requirements

### Gameplay Rules

- Each player starts with a **score of 0**.
- The player can only have **one active bet** at a time.
- Bets **resolve after one minute**, rounded up to `:00` seconds for simplicity.
- Once complete, the system compares:
  - **Creation Price** (when bet placed)
  - **Resolution Price** (after one minute)
- If the prediction is correct:
  - Score += 1
- If incorrect:
  - Score âˆ’= 1
- The score is computed **client-side** from bet history.

---

## Architecture

### Frontend

- **Stack:** React + TypeScript + Vite
- **UI Components:**
  - **Top Left:** Ticker name (fixed: BTCUSD; list support planned)
  - **Main Section:** Candlestick chart (minute granularity)
  - **Right Panel:** Two buttons:
    - ðŸŸ© Long Bet (Up)
    - ðŸŸ¥ Short Bet (Down)
  - **Bottom Section:**
    - Left: Userâ€™s **score**
    - Right: List of **bets**, sorted by date (latest first)
  - **Top Right:** Placeholder for Google Authentication (future enhancement)
- **Chart:** Uses OHLC data fetched from BE `/chart/{ticker}`
- **Authoriyation:** JWT token stored as a HTTP cookie
- **Score Calculation:** UI only, computed from resolved bets

---

### Backend

- **Stack:** Node.js + TypeScript
- **Endpoints:**

  | Method | Endpoint | Description |
  |--------|----------|-------------|
  | `POST` | `/auth` | Creates a new user/session |
  | `GET` | `/bets` | Returns list of user bets with details |
  | `POST` | `/bet/{ticker}/{short\|long}` | Creates a new bet |
  | `GET` | `/price/{ticker}/current` | Returns OHLC price data for the current and previous minute |
  | `GET` | `/price/{ticker}/historical` | Returns historical OHLC price data in minute granularity |
  
  - **Authentication Logic**

  - The `POST /auth` endpoint creates an user and returns its `token`
  - The token is in JWT format signed with a server secret and its payload contains the `user_id`
  - The `user_id` is generated by the DB on insert to the `users` table
  - The token is required to be present in the `Authorization` HTTP header for all other endpoints
  - The backend validates the token signature and ensures that the request only affects data belonging to the `user_id` in the token

- **Market Data Component:**
  - Fetches minute-granularity market data using **Binance API**
  - Caches data for the 24 hours
  - Returns current or historical data
  - For historical price requests it uses the **Candlestick REST API**
  - For current price requests it opens a **Candlestick Stream Websocket API** session
  - The websocket session is closed if no current price request arrives for the ticker in the lst 5 minutes

- **Business Logic:**
  - Bets are stored in `bets` table
  - `GET /bets` and `POST /bet` perform CRUD operations
  - `POST /bet` enforces a unique open bet constraint via the DB
  - Resolution time is calculated by adding a minute to the current time then rounding up to `:00` seconds
 
- **Bet Resolution Job**
  - Worker task running in the background
  - Wakes up every minute at :00 second
  - Reads open bets from `bets` table
  - Calls market data to get the price at resolution for all tickers
  - Updates status and resolution time in `bets` table
  - Sleeps until the beginning of the next minute after wakeup

---

### Database Schema

**Table: `bets`**

| Column | Type | Description |
|--------|------|-------------|
| `bet_id` | INT (PRIMARY KEY AUTO INCREMENT) | Unique bet identifier |
| `user_id` | INT | User identifier |
| `ticker` | VARCHAR | Ticker symbol (e.g., BTCUSD) |
| `open_date` | DATETIME | Time when bet was made |
| `resolution_date` | DATETIME | Bet expiration time (rounded up to minute) |
| `direction` | ENUM('LONG','SHORT') | Bet type |
| `open_price` | DECIMAL(10,4) | Price when bet was made |
| `resolution_price` | DECIMAL(10,4) (nullable) | Price at expiration |
| `status` | ENUM('OPEN','WON','LOST') | Bet status |
| **Indexes** | (`user_id`, `resolution_date DESC`) | For listing bets per user |
| **Constraint** | CREATE UNIQUE INDEX bets_user_ticker_status(`user_id`, `ticker`) WHERE `status` = 'OPEN' | Ensures one active bet per ticker per user |

**Table: `users`**

| Column | Type | Description |
|--------|------|-------------|
| `user_id` | INT (PRIMARY KEY AUTO INCREMENT) | Unique user identifier |
| `created_at` | DATETIME | Timestamp when the user account was created |

---

### Database Migrations

Since the schema is simple, initially no versioned migrations will be used

---

## Deployment

The application will run as **three Docker containers**, all based on **Alpine images**:

1. **Frontend Container**
   - Static React build served by **nginx**
   - Also acts as a **reverse proxy** to the backend API

2. **Backend Container**
   - Node.js server (REST API)
   - Connects to DB and Binance API

3. **Database Container**
   - MariaDB instance
   - Stores all bets

**Container Registry:** GitHub Container Registry (GHCR)

---

## Future Enhancements

- Add multiple tickers (ETHUSD, SOLUSD, etc.)
- Google authentication
- Move DB to managed cloud service (AWS RDS)

---

## Suggested Milestones

### **Phase 1: Setup & Scaffolding**
- [ ] Initialize repository and CI/CD workflow
- [ ] Create Vite + React TypeScript frontend scaffold
- [ ] Create Node.js + Express TypeScript backend scaffold
- [ ] Define Dockerfiles for FE, BE, DB

### **Phase 2: Backend Core**
- [ ] Implement `/chart/{ticker}` endpoint using Binance API
- [ ] Implement `/bet/{ticker}/{short|long}` with DB insertion and constraints
- [ ] Implement `/bets` to return and update bets with expiry checks
- [ ] Create SQL schema and migrations

### **Phase 3: Frontend Core**
- [ ] Implement static layout (chart, buttons, score, bet list)
- [ ] Integrate chart data from BE
- [ ] Implement placing bets and updating UI state
- [ ] Display user score and past bets

### **Phase 4: Persistence & Logic**
- [ ] Store user ID in cookie
- [ ] Ensure bets persist and reload correctly
- [ ] Compute score from bets client-side

### **Phase 5: Deployment**
- [ ] Containerize FE, BE, and DB
- [ ] Configure nginx reverse proxy
- [ ] Push images to GitHub Container Registry
- [ ] Deploy using Docker Compose or cloud VM

### **Phase 6: Testing & Polish**
- [ ] Add unit tests for BE logic
- [ ] Add E2E tests for FE (Playwright/Cypress)
- [ ] Validate correctness of bet resolution
- [ ] Prepare demo deployment link

---

## Deliverables

- Working **deployed web app** (accessible link)
- GitHub repository containing:
  - Frontend & backend code
  - Dockerfiles & compose config
  - `PROJECT.md` (this document)
- Optional: Screenshots or short demo video

---

## Success Criteria

- âœ… Bets resolve correctly based on minute-level market data  
- âœ… Users retain session and score via cookie  
- âœ… Frontend updates dynamically with real-time chart and results  
- âœ… App runs locally via Docker Compose  
- âœ… Deployable and publicly accessible  
```
